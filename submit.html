<!DOCTYPE html>
<html>
    <head>
        <title>Good Deed Marathon</title>

        <meta http-equiv="content-type" content="text/html;charset=iso-8859-1" />
        <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="msapplication-tap-highlight" content="no">

        <link rel="stylesheet" type="text/css" href="style.css" >


        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>   
        <script src="js/modernizr.custom.js"></script>
        <script src="phonegap.js"></script>
        <script src="cdv-plugin-fb-connect.js"></script>
        <script src="facebook-js-sdk.js"></script>
        <script src="js/plugins/SocialSharing.js"></script>

    </head>
    <body>
        <div id="st-container" class="st-container">
            <nav class="st-menu st-effect-13" id="menu-13">
                <ul>
                    <li><a class="icon icon-home" href="index.html">Home</a></li>
                    <li><a class="icon icon-submit" href="submit.html">Submit a Deed</a></li>
                    <li><a class="icon icon-goodDeed" href="gallery.html">Gallery</a></li>
                    <li><a class="icon icon-map" href="map.html">Map</a></li>
                    <li><a class="icon icon-prizes" href="rewards.html">Goodies</a></li>
                    <li><a class="icon icon-partner" href="partners.html">Partners</a></li>
                    <li><a class="icon icon-initiatives" href="justin.html">Just In!</a></li>
                </ul>
            </nav>
            <div class="st-pusher">
                <div class="st-content">
                    <div class="st-content-inner">
                        <header>
                            <p class="left-menu"><a href="#" data-effect="st-effect-13" id="trigger" class="menu-trigger">Open/Close Menu</a></p>
                            <p style="text-align: center; margin: 0; padding: 0;"><img src="images/gdm_logo.png" width="129" height="50" /></p>
                        </header>
                        <div id="home" class="content center-align">
                            <p class="color-blue">
                                Share your good deeds with everyone so they know how awesome you are! <br />
                                Tell us about them in any way you want.
                            </p>
                            <div class="submitModes">
                                <p id="textTool">Text <br />                                    
                                    <img src="images/sub-text_white.png" />
                                </p>
                                <p id="photoTool">Photo <br />
                                    <img src="images/sub-photo_white.png" />
                                </p>
                                <p id="videoTool">Video <br />
                                    <img src="images/sub-video-white.png" />
                                </p>
                                <p id="uploadTool">Gallery <br />
                                    <img src="images/ty-gallery-icon.png" />
                                </p>
                            </div>

                            <div id="textToolSubmit" class="submitDiv">

                                <form class="textToolSubmitForm" action="" method="post" >
                                    <textarea name="textsubmit" maxlength="140" class="color-green" required></textarea>
                                    <p class="color-blue"><span class="limit">140</span> Characters</p>
                                    <input type="image" class="textSubmitButton" src="images/submit.jpg" style="margin-top: 20px;" />                             
                                </form>
                            </div>

                            <div id="photoToolSubmit" class="submitDiv">
                                <form class="photoToolSubmitForm" method="post" enctype="multipart/form-data">
                                    <img id="photosubmit" src="images/pic.jpg" style="width:80%;margin-bottom: 20px;" />
                                    <textarea name="textsubmit" maxlength="140" class="color-green" required></textarea>
                                    <p class="color-blue"><span class="limit">140</span> Characters</p>
                                    <input type="image" id="photoSubmitButton" src="images/submit.jpg" style="margin-top: 20px;" />                             
                                </form>
                            </div>

                            <div id="videoToolSubmit" class="submitDiv">
                                <form class="videoToolSubmitForm" method="post" enctype="multipart/form-data">
                                    <video id="videosubmit" style="width:80%;margin-bottom: 20px;" controls="" autoplay="">
                                        <source src="">
                                    </video> 
                                    <textarea name="textsubmit" maxlength="140" class="color-green" required></textarea>
                                    <p class="color-blue"><span class="limit">140</span> Characters</p>
                                    <input id="videoSubmitButton" type="image" src="images/submit.jpg" style="margin-top: 20px;" />                             
                                </form>
                            </div>

                            <div id="uploadToolSubmit" class="submitDiv">
                                <form class="uploadToolSubmitForm" method="post" enctype="multipart/form-data">
                                    <img style="display: none;" id="uploadimg" src="images/pic.jpg" style="width:80%;margin-bottom: 20px;" />
                                    <video style="display: none;" id="uploadvideo" style="width:80%;margin-bottom: 20px;" controls="" autoplay="">
                                        <source src="">
                                    </video> 
                                    <textarea name="textsubmit" maxlength="140" class="color-green" required></textarea>
                                    <p class="color-blue"><span class="limit">140</span> Characters</p>
                                    <input id="uploadSubmitButton" type="image" src="images/submit.jpg" style="margin-top: 20px;" />                             
                                </form>
                            </div>

                            <div id="status" class="color-green"></div>
                        </div><!--home ends here-->
                    </div><!--st-content-inner ends here-->
                </div><!--.st-content ends here-->
            </div>
        </div><!--st-container ends here-->
        <script src="js/classie.js"></script>
        <script src="js/sidebarEffects.js"></script>
        <script>
            var pictureSource;   // picture source
            var destinationType; // sets the format of returned value
            var mediaType;

            // Wait for device API libraries to load
            //
            document.addEventListener("deviceready", onDeviceReady, false);

            // device APIs are available
            //
            function onDeviceReady() {
                pictureSource = navigator.camera.PictureSourceType;
                destinationType = navigator.camera.DestinationType;
                mediaType = navigator.camera.MediaType;

            }

           
            function capturePhoto() {
                navigator.camera.getPicture(onPhotoURISuccess, onFail, {
                    quality: 50,
                    destinationType: destinationType.FILE_URI,
                    targetWidth: 640,
                    targetHeight: 640
                });
            }

            function captureVideo() {
                navigator.device.capture.captureVideo(captureSuccess, captureError, {limit: 1, duration: 15});
            }

            function captureError(error) {
                var msg = 'An error occurred during capture: ' + error.code;
                navigator.notification.alert(msg, null, 'Uh oh!');
            }

            function getPhoto(source) {
                navigator.camera.getPicture(onURISuccess, onFail, {quality: 50,
                    destinationType: destinationType.FILE_URI,
                    sourceType: source,
                    MediaType: mediaType.ALLMEDIA
                });
            }

            function onPhotoURISuccess(imageURI) {
                var largeImage = document.getElementById('photosubmit');
                largeImage.style.display = 'block';
                largeImage.src = imageURI;
                $("#photoToolSubmit").show();
            }

            function captureSuccess(mediaFiles) {
                mediaFiles[0].getFormatData(function(data) {
                    if (data.duration > 15) {
                        alert("Your video is longer than the allowed 15 seconds. Please record a new video. You can trim your video after it's been recorded.");
                    } else {
                        $("#videosubmit")[0].src = mediaFiles[0].fullPath;
                        $("#videosubmit")[0].play();
                        $("#videoToolSubmit").show();

                    }
                });
            }

            function onURISuccess(mediaFiles) {
                var res = mediaFiles[0].type.match(/image/g);
                if (res.length > 0) {
                    $("#uploadvideo").hide();
                    var largeImage = document.getElementById('uploadimg');
                    largeImage.style.display = 'block';
                    largeImage.src = mediaFiles[0].fullPath;
                } else {
                    mediaFiles[0].getFormatData(function(data) {
                        if (data.duration > 15) {
                            alert("Your video is longer than the allowed 15 seconds. Please record a new video. You can trim your video after it's been recorded.");
                        } else {
                            $("#uploadimg").hide();
                            $("#uploadvideo")[0].src = mediaFiles[0].fullPath;
                            $("#uploadvideo").show();
                            $("#uploadvideo")[0].play();
                        }
                    });
                }
                $("#uploadToolSubmit").show();
            }

            function onFail(message) {
                alert('Failed because: ' + message);
            }

            function upload(imageURI) {
                var options = new FileUploadOptions();
                options.fileKey = "file";
                var prof_id = window.localStorage.getItem("id");
                var msg = $("#photoToolSubmit textarea").val();
                var imagefilename = prof_id + "_" + Number(new Date()) + ".jpg";
                options.fileName = imagefilename;
                options.mimeType = "image/jpg";

                var params = new Object();
                params.imageURI = imageURI;
                params.prof_id = window.localStorage.getItem("id");
                params.msg = msg;
                options.params = params;
                options.chunkedMode = false;
                var ft = new FileTransfer();
                var url = "http://www.gooddeedmarathon.com/upload.php";

                var statusDom = document.querySelector('#status');
                ft.onprogress = function(progressEvent) {
                    $("#status").show();
                    if (progressEvent.lengthComputable) {
                        var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
                        statusDom.innerHTML = perc + "% loaded...";
                    } else {
                        if (statusDom.innerHTML == "") {
                            statusDom.innerHTML = "Loading";
                        } else {
                            statusDom.innerHTML += ".";
                        }
                    }
                };
                ft.upload(imageURI, url, win, fail, options, true);
            }

            function uploadVideo(mediaFile) {
                var videoURI = mediaFile;
                alert(videoURI);
                var options = new FileUploadOptions();
                options.fileKey = "file";
                var prof_id = window.localStorage.getItem("id");
                var msg = $("#videoToolSubmit textarea").val();
                var imagefilename = prof_id + "_" + Number(new Date()) + ".mp4";
                options.fileName = imagefilename;
                options.mimeType = "video/mp4";

                var params = new Object();
                params.videoURI = videoURI;
                params.prof_id = window.localStorage.getItem("id");
                params.msg = msg;
                options.params = params;
                options.chunkedMode = true;
                var ft = new FileTransfer();
                var url = "http://www.gooddeedmarathon.com/upload.php";

                var statusDom = document.querySelector('#status');
                ft.onprogress = function(progressEvent) {
                    $("#status").show();
                    if (progressEvent.lengthComputable) {
                        var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
                        statusDom.innerHTML = perc + "% loaded...";
                    } else {
                        if (statusDom.innerHTML == "") {
                            statusDom.innerHTML = "Loading";
                        } else {
                            statusDom.innerHTML += ".";
                        }
                    }
                };
                ft.upload(videoURI, url, win, fail, options, true);
            }

            function uploadImgLib(imageURI) {
                var options = new FileUploadOptions();
                options.fileKey = "file";
                var prof_id = window.localStorage.getItem("id");
                var msg = $("#uploadToolSubmit textarea").val();
                var imagefilename = prof_id + "_" + Number(new Date()) + ".jpg";
                options.fileName = imagefilename;
                options.mimeType = "image/jpg";

                var params = new Object();
                params.imageURI = imageURI;
                params.prof_id = window.localStorage.getItem("id");
                params.msg = msg;
                options.params = params;
                options.chunkedMode = false;
                var ft = new FileTransfer();
                var url = "http://www.gooddeedmarathon.com/upload.php";

                var statusDom = document.querySelector('#status');
                ft.onprogress = function(progressEvent) {
                    $("#status").show();
                    if (progressEvent.lengthComputable) {
                        var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
                        statusDom.innerHTML = perc + "% loaded...";
                    } else {
                        if (statusDom.innerHTML == "") {
                            statusDom.innerHTML = "Loading";
                        } else {
                            statusDom.innerHTML += ".";
                        }
                    }
                };
                ft.upload(imageURI, url, win, fail, options, true);
            }

            function uploadVideoLib(mediaFile) {
                var videoURI = mediaFile;
                alert(videoURI);
                var options = new FileUploadOptions();
                options.fileKey = "file";
                var prof_id = window.localStorage.getItem("id");
                var msg = $("#uploadToolSubmit textarea").val();
                var imagefilename = prof_id + "_" + Number(new Date()) + ".mp4";
                options.fileName = imagefilename;
                options.mimeType = "video/mp4";

                var params = new Object();
                params.videoURI = videoURI;
                params.prof_id = window.localStorage.getItem("id");
                params.msg = msg;
                options.params = params;
                options.chunkedMode = true;
                var ft = new FileTransfer();
                var url = "http://www.gooddeedmarathon.com/upload.php";

                var statusDom = document.querySelector('#status');
                ft.onprogress = function(progressEvent) {
                    $("#status").show();
                    if (progressEvent.lengthComputable) {
                        var perc = Math.floor(progressEvent.loaded / progressEvent.total * 100);
                        statusDom.innerHTML = perc + "% loaded...";
                    } else {
                        if (statusDom.innerHTML == "") {
                            statusDom.innerHTML = "Loading";
                        } else {
                            statusDom.innerHTML += ".";
                        }
                    }
                };
                ft.upload(videoURI, url, win, fail, options, true);
            }

            function win(r) {
                $("#status").hide();
                alert(JSON.stringify(r));
                alert("Image uploaded successfully!!");
            }

            function fail(error) {
                alert(error);
            }

            $(document).ready(function() {
                $("#textTool").click(function() {
                    $(this).siblings("p").removeClass("color-green");
                    $(this).addClass("color-green");
                    $(this).children("img").attr("src", "images/sub-text_green.png");

                    $("#photoTool img").attr("src", "images/sub-photo_white.png");
                    $("#videoTool img").attr("src", "images/sub-video-white.png");
                    $("#uploadTool img").attr("src", "images/ty-gallery-icon.png");
                    $(".submitDiv").hide();
                    $("#textToolSubmit").show();

                });

                $("#photoTool").click(function() {
                    $(this).siblings("p").removeClass("color-green");
                    $(this).addClass("color-green");
                    $(this).children("img").attr("src", "images/sub-photo_green.png");

                    $("#textTool img").attr("src", "images/sub-text_white.png");
                    $("#videoTool img").attr("src", "images/sub-video-white.png");
                    $("#uploadTool img").attr("src", "images/ty-gallery-icon.png");
                    $(".submitDiv").hide();
                    capturePhoto();


                });

                $("#videoTool").click(function() {
                    $(this).siblings("p").removeClass("color-green");
                    $(this).addClass("color-green");
                    $(this).children("img").attr("src", "images/sub-video-green.png");


                    $("#textTool img").attr("src", "images/sub-text_white.png");
                    $("#photoTool img").attr("src", "images/sub-photo_white.png");
                    $("#uploadTool img").attr("src", "images/ty-gallery-icon.png");


                    $(".submitDiv").hide();
                    captureVideo();
                });

                $("#uploadTool").click(function() {
                    $(this).siblings("p").removeClass("color-green");
                    $(this).addClass("color-green");
                    $(this).children("img").attr("src", "images/ty-gallery-icon-green.png");

                    $("#textTool img").attr("src", "images/sub-text_white.png");
                    $("#photoTool img").attr("src", "images/sub-photo_white.png");
                    $("#videoTool img").attr("src", "images/sub-video-white.png");


                    $(".submitDiv").hide();
                    getPhoto(pictureSource.PHOTOLIBRARY);

                });

                $("#photoSubmitButton").click(function(e) {
                    e.preventDefault();
                    upload($("#photosubmit").attr("src"));
                });

                $("#videoSubmitButton").click(function(e) {
                    e.preventDefault();
                    uploadVideo($("#videosubmit")[0].src);
                });

                $("#uploadSubmitButton").click(function(e) {
                    e.preventDefault();
                    if ($("#uploadimg").css("display") == "none") {
                        uploadImgLib($("#uploadimg").attr("src"));
                    } else {
                        uploadVideoLib($("#uploadvideo")[0].src);
                    }

                });
            });

        </script>

    </body>
</html>